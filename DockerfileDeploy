FROM golang
WORKDIR $GOPATH/src/github.com/infrmods/xbus
COPY --chown=app:app . .
RUN go env -w GOPROXY=https://goproxy.cn
RUN CGO_ENABLED=0 go build
RUN cp xbus /xbus

FROM alpine
COPY --chown=app:app --from=0 /xbus /usr/bin/xbus
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \
   && apk update && apk add curl
RUN adduser -D app
USER app
WORKDIR /xbus
RUN mkdir -p ~/logs
CMD ["/usr/bin/xbus", "-v=1", "-config", "/xbus/config.yaml", "run"]
